\ProvidesPackage{itdr/core}[2024/04/20]

\RequirePackage{comment}
\RequirePackage[inner=1in,outer=1in,top=1.36in,bottom=1.36in,footskip=0.3in]{geometry}
\RequirePackage{graphicx}
	\graphicspath{ {./img/} {./img/pic/} {./pic/} {./itdr/img/} }
\RequirePackage{fp}
\RequirePackage{lipsum}
\RequirePackage{mdframed}
\RequirePackage{multirow}
\RequirePackage[super]{nth}
\RequirePackage{setspace}
\RequirePackage{xfrac}% for the \sfrac fractions
\RequirePackage{xifthen}
\RequirePackage{xstring}

%%%%%%%%%%
% COLORS %
%%%%%%%%%%

\RequirePackage[table,svgnames]{xcolor}
\colorlet{dColor1}{white}
\colorlet{dColor2}{lightgray!75}

%%%%%%%%%
% BOXES %
%%%%%%%%%

\mdfsetup{
	backgroundcolor=white,
	innerleftmargin=5pt,
	innerrightmargin=5pt,
	innertopmargin=4pt,
	innerbottommargin=2pt,
	leftmargin=1em,
	rightmargin=1em,
	linewidth=1pt,
	linecolor=black,
	skipabove=0ex,
	skipbelow=0.5ex,
}

\makeatletter

\newlength{\box@decor@width}
\setlength{\box@decor@width}{1.0324\linewidth}
\newlength{\box@decor@hoffset}
\setlength{\box@decor@hoffset}{-0.0155\linewidth}

% "default" box
\newenvironment{dbox}{%
	\par\noindent\begin{minipage}{\linewidth}%
		\noindent\vspace{-13.38pt}\hspace{\box@decor@hoffset}% box_top position
		\includegraphics[width=\box@decor@width]{box_top.pdf}%
		\begin{mdframed}[%
			backgroundcolor=dColor2,
			hidealllines=true,
			]%
		}{ % <- the space here is left intentionally
		\end{mdframed}%
		\vspace{-8pt}\noindent\hspace{\box@decor@hoffset}% box_bottom position
		\includegraphics[width=\box@decor@width]{box_bottom.pdf}%
	\end{minipage}\par%
}

% "aloud" box
\newenvironment{abox}{%
	\par\noindent\begin{minipage}{\linewidth}%
		\noindent\vspace{-11.38pt}\hspace{\box@decor@hoffset}% box_quote position
		\includegraphics[width=\box@decor@width]{box_quote.pdf}%
		\begin{mdframed}[%
			align=center,
			topline=false,
			bottomline=false,
			innertopmargin=2pt,
			innerbottommargin=0pt,
			]%
		}{ % <- the space here is left intentionally
		\end{mdframed}%
		\vspace{-8pt}\noindent\hspace{\box@decor@hoffset}% box_quote position
		\includegraphics[width=\box@decor@width]{box_quote.pdf}%
	\end{minipage}\par%
}

% "quote" box
\newenvironment{qbox}{%
	\par\noindent\begin{minipage}{\linewidth}%
		\begin{mdframed}[%
			align=center,
			]%
		}{ % <- the space here is left intentionally
		\end{mdframed}%
	\end{minipage}\par%
}

% centered box
\RequirePackage{environ}
\RequirePackage{varwidth}
\newlength{\cbox@width}
\NewEnviron{cbox}{%
	\setlength{\cbox@width}{\dimexpr%
		+\mdflength{innerleftmargin}
		+\mdflength{innerrightmargin}
		+2\mdflength{linewidth}
		\relax}% setlength
	\savebox0{%
		\begin{varwidth}{\dimexpr\linewidth-\cbox@width\relax}%
			\BODY
		\end{varwidth}%
	}% savebox
	\par\noindent\vspace*{-2ex}%
	\begin{mdframed}[%
		align=center,
		userdefinedwidth=\dimexpr\wd0+\cbox@width\relax,
		]%
		\usebox0
	\end{mdframed}\par%
}

% "background" box
\newsavebox{\s@bbox}
\newenvironment{bbox}{%
	\par\noindent\hspace*{-\fboxsep}%
	\begin{lrbox}{\s@bbox}%
		\begin{minipage}{\linewidth}%
		}{%
		\end{minipage}%
	\end{lrbox}%
	\colorbox{dColor2}{\usebox{\s@bbox}\par}%
}

% left bar
\newenvironment{lbar}{%
	\par\noindent\begin{minipage}{\linewidth}%
		\begin{mdframed}[%
			align=center,
			topline=false,
			bottomline=false,
			rightline=false,
			innertopmargin=1pt,
			innerbottommargin=0pt,
			]%
		}{ % <- the space here is left intentionally
		\end{mdframed}%
	\end{minipage}\par%
}

\makeatother

% \rightbox[\parskip]{text}
% put a right-aligned line of text raised by \baselineskip + #1
% default of #1 is \parskip to put the text on a \paragraph{} line above
\newcommand{\rightbox}[2][\parskip]{%
	\def\spc{\dimexpr #1\relax}%
	\makebox[\linewidth][r]{\raisebox{\baselineskip+\spc}[0pt][0pt]{#2}}\vspace{-\baselineskip}%
}

% \righttext{text}
% right-aligned text
\newcommand{\righttext}[1]{{%
		\unskip\nobreak\hfil\penalty50
		\hskip2em\hbox{}\nobreak\hfil#1
		\parfillskip=0pt \finalhyphendemerits=0 \par%
}}

%%%%%%%%%%%%
% FANCYHDR %
%%%%%%%%%%%%

\RequirePackage{fancyhdr}

\renewcommand{\headrulewidth}{1pt}

\newlength{\bottomLineVspace}
\setlength{\bottomLineVspace}{-3.8ex}

% define fancy page style
\fancypagestyle{fancy}{%
	\fancyhf{}% clear headers and footers
	
	\fancyhead[LE,RO]{%
		{\textsc{\nouppercase{\leftmark}}}%
	}
	\fancyhead[LO,RE]{%
		{\scshape\title}%
	}
	\fancyfoot[LE]{%
		\thepage
		\vspace{\bottomLineVspace}
		\includegraphics[width=\linewidth]{bottom_line_even.pdf}%
	}
	\fancyfoot[RO]{%
		\thepage
		\vspace{\bottomLineVspace}
		\includegraphics[width=\linewidth]{bottom_line_odd.pdf}%
	}
}

% toc page style
\fancypagestyle{toc}{%
	\fancyhf{}% clear headers and footers
	\fancyhead[LO,RE]{{\scshape\title}}
}

\fancypagestyle{plain}{}% redefine plain page style
\pagestyle{fancy}% set fancy page style

% Change chaptermark
\renewcommand{\chaptermark}[1]{%
	\markboth{\chaptername\ \thechapter\ #1}{}%
}

%%%%%%%%%
% FONTS %
%%%%%%%%%

% Document font size
\newlength{\docFontSize}
\makeatletter
\setlength{\docFontSize}{\f@size pt}
\makeatother

\RequirePackage{fourier}% special symbols
\RequirePackage{adfbullets}% special symbols
\RequirePackage{humanist}% fancy title font
\RequirePackage[T1]{fontenc}
\RequirePackage{microtype}
\DisableLigatures[s]{family=hmin}% disable s-ligatures for the humanist font family
\newcommand*{\fancyfont}{\hminfamily}

% \textBigTitle[size][baselineskip]{text}
\NewDocumentCommand{\textBigTitle}{ O{30} O{24} m }{%
	{\fancyfont\fontsize{#1}{#2}\bfseries\selectfont #3\linebreak}%
}

% \textSubTitle[size][baselineskip]{text}
\NewDocumentCommand{\textSubTitle}{ O{18} O{16} m }{%
	{\fancyfont\fontsize{#1}{#2}\selectfont #3\linebreak}%
}

%%%%%%%%%%%%%
% FOOTNOTES %
%%%%%%%%%%%%%

% Footnote style
\RequirePackage[perpage,symbol*]{footmisc}
\RequirePackage{sepfootnotes}

% Set footnote font size
\def\fnsize{\small}

\renewcommand{\thefootnote}{\fnsize\fnsymbol{footnote}}
\renewcommand{\footnotelayout}{\fnsize\em}% footnote text style

% \note[n]
% footnote symbol for a local note
\makeatletter
\newcommand{\note}[1][1]{\textsuperscript{\normalfont\fnsize\@fnsymbol{#1}}}
\makeatother

% \notetext[n]{text}
\newcommand{\notetext}[2][1]{\note[#1]~{\fnsize\em #2}}

%%%%%%%%%
% ICONS %
%%%%%%%%%

\RequirePackage{tikz}

% \iconItDR
\newcommand{\iconItDR}{%
	\begin{tikzpicture}[baseline={([yshift=-0.35\docFontSize]current bounding box.center)}, y=\docFontSize, x=\docFontSize, yscale=0.1, xscale=0.1, inner sep=0pt, outer sep=0pt]
		\path[fill,line width=1.000pt] (5.2798,15.5906) .. controls (4.1738, 15.5906)
		and (3.5288, 15.5659) .. (3.2503, 15.3603) .. controls (2.9717, 15.1547) and
		(3.0992, 14.3930) .. (3.1483, 14.2321) .. controls (3.1976, 14.0703) and
		(3.3015, 13.9255) .. (3.3925, 13.8907) .. controls (3.4582, 13.8656) and
		(4.0423, 13.8907) .. (4.0749, 13.8381) .. controls (4.0831, 13.8253) and
		(4.0155, 13.5309) .. (4.0618, 13.1882) .. controls (3.5475, 13.1942) and
		(2.6229, 12.8178) .. (2.4345, 12.2964) .. controls (1.7236, 12.4526) and
		(0.7850, 11.0161) .. (0.9842, 10.7004) .. controls (0.7624, 10.6434) and
		(0.0733, 9.7764) .. (0.3793, 8.7767) .. controls (0.1338, 8.5377) and
		(-0.0812, 7.8890) .. (0.2693, 6.9831) .. controls (0.1772, 6.8004) and
		(-0.2872, 6.2146) .. (0.2685, 5.1407) .. controls (-0.0648, 4.6093) and
		(0.0412, 3.6883) .. (0.2425, 3.1493) .. controls (0.8470, 2.8839) and (2.4777,
		2.9585) .. (2.9061, 3.1387) .. controls (3.0395, 3.0696) and (3.4168, 3.0387)
		.. (4.1024, 3.0354) .. controls (4.1762, 1.4826) and (5.1058, 0.0004) ..
		(5.2796, 0.0000) .. controls (5.3780, -0.0002) and (6.2540, 1.2198) ..
		(6.4580, 3.0275) .. controls (7.1821, 3.0290) and (7.6510, 2.9837) .. (7.7526,
		3.2243) .. controls (7.9095, 2.8908) and (9.9240, 2.9727) .. (10.2722, 3.1372)
		.. controls (10.4824, 3.2365) and (10.7394, 4.4524) .. (10.3639, 5.1153) ..
		controls (10.6500, 5.7594) and (10.6056, 6.8875) .. (10.3539, 7.0630) ..
		controls (10.5986, 7.6494) and (10.4313, 8.5565) .. (10.1884, 8.7699) ..
		controls (10.3765, 9.1891) and (10.1110, 10.5027) .. (9.5837, 10.6014) ..
		controls (9.6474, 11.3672) and (9.0052, 12.2235) .. (8.2670, 12.2623) ..
		controls (8.1643, 12.7448) and (6.9069, 13.3428) .. (6.3801, 13.1770) ..
		controls (6.4739, 13.5481) and (6.4106, 13.7708) .. (6.3575, 13.8767) ..
		controls (6.4813, 13.8653) and (7.0583, 13.8667) .. (7.1388, 13.8827) ..
		controls (7.4720, 13.9493) and (7.5716, 15.1694) .. (7.2962, 15.3680) ..
		controls (7.0207, 15.5666) and (6.3857, 15.5904) .. (5.2800, 15.5904) ..
		controls (4.6077, 15.5904) and (5.2800, 15.5905) .. (5.2800, 15.5905) ..
		controls (5.2800, 15.5905) and (5.9525, 15.5905) .. (5.2800, 15.5905) --
		cycle(7.0926,15.1630) .. controls (7.2293, 15.0647) and (7.1731, 14.2028) ..
		(7.0100, 14.1998) .. controls (6.1662, 14.1842) and (4.0727, 14.1805) ..
		(3.5563, 14.2113) .. controls (3.4181, 14.2196) and (3.3575, 15.0085) ..
		(3.4260, 15.1234) .. controls (3.5787, 15.3796) and (6.8647, 15.3269) ..
		(7.0926, 15.1630) -- cycle(6.0569,13.2274) .. controls (5.8770, 13.1719) and
		(5.5657, 13.4618) .. (4.6864, 13.9230) .. controls (5.1068, 13.9474) and
		(5.7777, 13.9120) .. (6.0228, 13.8849) .. controls (6.1790, 13.8677) and
		(6.2368, 13.2830) .. (6.0569, 13.2274) -- cycle(4.4896,13.0879) .. controls
		(4.3580, 13.2075) and (4.3391, 13.8026) .. (4.4486, 13.7637) .. controls
		(4.9105, 13.5997) and (5.6941, 13.0574) .. (6.0229, 12.8613) .. controls
		(6.2425, 12.7303) and (6.1892, 12.1832) .. (6.0536, 12.1832) .. controls
		(5.8762, 12.1832) and (4.6358, 12.9549) .. (4.4896, 13.0880) --
		cycle(7.8657,12.2662) .. controls (7.8662, 12.2011) and (7.1187, 10.9011) ..
		(6.7767, 10.8058) .. controls (6.4459, 10.7138) and (6.3111, 10.8292) ..
		(6.2851, 10.9301) .. controls (6.5217, 11.2616) and (6.4457, 11.7927) ..
		(6.3391, 11.9721) .. controls (6.4722, 12.2860) and (6.4411, 12.6967) ..
		(6.3390, 12.8563) .. controls (6.8851, 12.9745) and (7.8645, 12.3538) ..
		(7.8657, 12.2662) -- cycle(4.1776,12.8740) .. controls (4.1679, 12.8665) and
		(3.9641, 12.4164) .. (4.1829, 11.9975) .. controls (3.9026, 11.4883) and
		(4.2399, 10.9628) .. (4.1957, 10.8502) .. controls (4.1467, 10.7256) and
		(4.0155, 10.7388) .. (3.9261, 10.7277) .. controls (3.2660, 10.9864) and
		(2.6657, 12.2431) .. (2.7369, 12.3127) .. controls (3.1284, 12.6952) and
		(3.6500, 12.8895) .. (4.1776, 12.8740) -- cycle(4.4736,12.0412) .. controls
		(4.3331, 12.1139) and (4.3567, 12.7526) .. (4.4895, 12.6845) .. controls
		(5.0604, 12.3917) and (5.5346, 12.1353) .. (5.9918, 11.8264) .. controls
		(6.0644, 11.7772) and (6.2213, 11.2580) .. (6.0536, 11.1908) .. controls
		(5.9174, 11.1362) and (4.8591, 11.8418) .. (4.4736, 12.0411) --
		cycle(9.2390,10.7150) .. controls (9.1175, 10.5077) and (8.0277, 10.0980) ..
		(7.7165, 9.8534) .. controls (7.7070, 9.8459) and (7.4842, 9.6810) .. (7.1972,
		10.1049) .. controls (6.8164, 10.6672) and (8.2157, 11.9801) .. (8.3029,
		11.9605) .. controls (8.6687, 11.8785) and (9.4399, 11.0554) .. (9.2390,
		10.7150) -- cycle(3.5205,10.4479) .. controls (3.5968, 10.1242) and (3.0617,
		9.7583) .. (2.9516, 9.7855) .. controls (2.8416, 9.8126) and (1.8115, 10.4143)
		.. (1.2917, 10.7958) .. controls (1.1999, 10.9579) and (2.0086, 11.9710) ..
		(2.2902, 11.9773) .. controls (2.6635, 11.9856) and (3.4836, 10.6041) ..
		(3.5205, 10.4479) -- cycle(4.6047,11.6951) .. controls (5.0705, 11.4236) and
		(5.7573, 11.0403) .. (6.0122, 10.8747) .. controls (6.1309, 10.7976) and
		(6.1002, 10.4704) .. (6.0042, 10.3625) .. controls (5.8726, 10.2143) and
		(4.6206, 10.9656) .. (4.4389, 11.0984) .. controls (4.3178, 11.1869) and
		(4.2989, 11.8735) .. (4.6047, 11.6951) -- cycle(6.0177,9.9345) .. controls
		(6.0132, 9.8009) and (5.0417, 9.9025) .. (4.6042, 9.8883) .. controls (4.3093,
		9.8788) and (4.3167, 10.7599) .. (4.4932, 10.6843) .. controls (5.0876,
		10.4296) and (6.0233, 10.1051) .. (6.0177, 9.9345) -- cycle(2.7850,9.4350) ..
		controls (3.0054, 9.2650) and (2.7754, 8.4575) .. (2.6588, 8.4643) .. controls
		(2.2988, 8.4854) and (0.6612, 8.8416) .. (0.6327, 8.9774) .. controls (0.5475,
		9.3827) and (0.7580, 10.2391) .. (1.1134, 10.3666) .. controls (1.3167,
		10.4395) and (2.3581, 9.7642) .. (2.7850, 9.4349) -- cycle(9.4700,10.3217) ..
		controls (9.7116, 10.3476) and (10.0381, 9.1548) .. (9.9709, 9.0472) ..
		controls (9.8349, 8.8295) and (8.1587, 8.4533) .. (7.9707, 8.4657) .. controls
		(7.6983, 8.4836) and (7.5761, 9.3823) .. (7.8814, 9.5944) .. controls (8.3619,
		9.9283) and (8.8971, 10.2600) .. (9.4700, 10.3216) -- cycle(7.3073,9.4115) ..
		controls (7.4857, 9.3092) and (7.4402, 8.4485) .. (7.1393, 8.4420) .. controls
		(5.9214, 8.4154) and (4.7071, 8.5048) .. (3.4850, 8.4390) .. controls (3.0744,
		8.4168) and (3.1057, 9.4024) .. (3.3882, 9.4402) .. controls (3.5766, 9.4654)
		and (7.0811, 9.5412) .. (7.3073, 9.4115) -- cycle(2.6099,8.0006) .. controls
		(2.6261, 7.9237) and (2.6615, 6.9965) .. (2.4521, 6.9711) .. controls (1.7864,
		6.9432) and (0.9031, 7.0052) .. (0.5497, 7.1785) .. controls (0.3845, 7.2595)
		and (0.3884, 8.3721) .. (0.5961, 8.5199) .. controls (0.7760, 8.6479) and
		(2.5621, 8.2267) .. (2.6099, 8.0006) -- cycle(9.9706,8.5199) .. controls
		(10.1807, 8.3701) and (10.2587, 7.3376) .. (10.0887, 7.2418) .. controls
		(9.7770, 7.0662) and (8.8292, 7.1237) .. (8.1919, 6.9547) .. controls (7.9033,
		6.8782) and (7.8408, 7.8494) .. (7.9458, 7.9822) .. controls (8.1188, 8.2011)
		and (9.7895, 8.6490) .. (9.9706, 8.5199) -- cycle(4.2209,8.1089) .. controls
		(4.9218, 8.1074) and (5.6228, 8.1036) .. (6.3235, 8.0941) .. controls (6.0910,
		7.4911) and (6.1606, 6.5986) .. (6.1656, 5.3079) .. controls (5.7518, 5.3057)
		and (5.4931, 5.3034) .. (5.4294, 5.2920) .. controls (5.4249, 6.1872) and
		(5.4416, 7.2758) .. (5.2999, 7.2687) .. controls (5.1844, 7.2627) and (5.1439,
		6.5885) .. (5.1423, 5.2937) .. controls (5.0491, 5.3135) and (4.8433, 5.3185)
		.. (4.3944, 5.3174) .. controls (4.4166, 6.7989) and (4.3584, 7.7223) ..
		(4.2209, 8.1088) -- cycle(8.0342,6.6390) .. controls (8.2392, 6.7394) and
		(10.0202, 6.8414) .. (10.1316, 6.7477) .. controls (10.3291, 6.5817) and
		(10.2929, 5.5430) .. (10.1495, 5.3802) .. controls (10.0061, 5.2175) and
		(8.0888, 5.2588) .. (7.9740, 5.3787) .. controls (7.8592, 5.4987) and (7.8672,
		6.5571) .. (8.0342, 6.6389) -- cycle(2.4453,5.3536) .. controls (2.2197,
		5.3402) and (0.5645, 5.3191) .. (0.4830, 5.4290) .. controls (0.3167, 5.6535)
		and (0.3676, 6.6144) .. (0.5006, 6.7392) .. controls (0.5732, 6.8074) and
		(2.0433, 6.7520) .. (2.4532, 6.6493) .. controls (2.6346, 6.6038) and (2.6395,
		5.3651) .. (2.4453, 5.3535) -- cycle(8.0080,3.4303) .. controls (7.8686,
		3.4602) and (7.8388, 5.0344) .. (7.9944, 5.0214) .. controls (8.6583, 4.9660)
		and (9.5199, 4.9777) .. (10.0129, 5.0136) .. controls (10.2940, 5.0341) and
		(10.2747, 3.5665) .. (10.0434, 3.4644) .. controls (9.8121, 3.3623) and
		(8.4663, 3.3319) .. (8.0080, 3.4303) -- cycle(2.6119,3.4311) .. controls
		(2.2357, 3.3268) and (0.7836, 3.2972) .. (0.5268, 3.4152) .. controls (0.2425,
		3.5466) and (0.3645, 4.9867) .. (0.5283, 4.9913) .. controls (1.2470, 5.0111)
		and (1.9322, 4.9793) .. (2.3278, 4.9721) .. controls (2.8253, 4.9632) and
		(2.7238, 4.7679) .. (2.7282, 4.2770) .. controls (2.7327, 3.7862) and (2.7827,
		3.4784) .. (2.6117, 3.4310) -- cycle(4.9908,3.3759) .. controls (4.3522,
		3.3274) and (3.8620, 3.3512) .. (3.2265, 3.4032) .. controls (3.0225, 3.4198)
		and (2.9562, 4.6918) .. (3.1037, 4.8604) .. controls (3.2852, 5.0678) and
		(4.8173, 5.0007) .. (5.0914, 4.8962) .. controls (5.2092, 4.8513) and (5.2109,
		3.3926) .. (4.9908, 3.3759) -- cycle(5.4956,3.4820) .. controls (5.4239,
		3.5423) and (5.3280, 4.8908) .. (5.5600, 4.9129) .. controls (6.1701, 4.9710)
		and (7.0015, 5.0003) .. (7.4092, 5.0061) .. controls (7.6385, 5.0091) and
		(7.7115, 3.4267) .. (7.4115, 3.4107) .. controls (7.2314, 3.4011) and (5.7392,
		3.2771) .. (5.4955, 3.4819) -- cycle(6.0974,3.0242) .. controls (6.0423,
		2.0691) and (5.6841, 1.2081) .. (5.2798, 0.3591) .. controls (4.7867, 1.1852)
		and (4.5928, 2.0928) .. (4.4621, 3.0342) .. controls (4.9497, 3.0365) and
		(5.0861, 3.0420) .. (5.1607, 3.0978) .. controls (5.1630, 2.5739) and (5.2095,
		1.5191) .. (5.2966, 1.5226) .. controls (5.3931, 1.5263) and (5.4014, 2.6027)
		.. (5.3952, 3.1011) .. controls (5.3952, 3.1011) and (5.6581, 3.0253) ..
		(6.0974, 3.0242) -- cycle;
	\end{tikzpicture}
}

% \faOldKey - old key icon (from fontawesome v4)
\newcommand{\faOldKey}{%
	\begin{tikzpicture}[baseline={([yshift=-0.35\docFontSize]current bounding box.center)}, y=\docFontSize, x=\docFontSize, yscale=0.1, xscale=0.1, inner sep=0pt, outer sep=0pt]
		\path[fill,line width=0.750pt] (5.2262,7.5879) .. controls (5.2262, 7.9229) and
		(5.1089, 8.2077) .. (4.8744, 8.4422) .. controls (4.6399, 8.6767) and (4.3552,
		8.7939) .. (4.0202, 8.7939) .. controls (3.6852, 8.7939) and (3.4004, 8.6767)
		.. (3.1659, 8.4422) .. controls (2.9314, 8.2077) and (2.8142, 7.9229) ..
		(2.8142, 7.5879) .. controls (2.8142, 7.4121) and (2.8539, 7.2383) .. (2.9335,
		7.0666) .. controls (2.7618, 7.1462) and (2.5880, 7.1859) .. (2.4122, 7.1859)
		.. controls (2.0772, 7.1859) and (1.7924, 7.0687) .. (1.5579, 6.8342) ..
		controls (1.3234, 6.5997) and (1.2062, 6.3149) .. (1.2062, 5.9799) .. controls
		(1.2062, 5.6449) and (1.3234, 5.3602) .. (1.5579, 5.1257) .. controls (1.7924,
		4.8912) and (2.0772, 4.7739) .. (2.4122, 4.7739) .. controls (2.7472, 4.7739)
		and (3.0319, 4.8912) .. (3.2664, 5.1257) .. controls (3.5009, 5.3602) and
		(3.6182, 5.6449) .. (3.6182, 5.9799) .. controls (3.6182, 6.1558) and (3.5784,
		6.3296) .. (3.4988, 6.5013) .. controls (3.6705, 6.4217) and (3.8443, 6.3819)
		.. (4.0202, 6.3819) .. controls (4.3552, 6.3819) and (4.6399, 6.4992) ..
		(4.8744, 6.7337) .. controls (5.1089, 6.9682) and (5.2262, 7.2529) .. (5.2262,
		7.5879) -- cycle(10.5716,3.1658) .. controls (10.5716, 3.0946) and (10.4690,
		2.9564) .. (10.2638, 2.7512) .. controls (10.0586, 2.5460) and (9.9204,
		2.4434) .. (9.8492, 2.4434) .. controls (9.8116, 2.4434) and (9.7519, 2.4769)
		.. (9.6702, 2.5439) .. controls (9.5886, 2.6109) and (9.5121, 2.6800) ..
		(9.4410, 2.7512) .. controls (9.3698, 2.8224) and (9.2892, 2.9062) .. (9.1991,
		3.0025) .. controls (9.1091, 3.0988) and (9.0578, 3.1532) .. (9.0452, 3.1658)
		-- (8.4422,2.5628) -- (9.8241,1.1809) .. controls (9.9414, 1.0636) and
		(10.0000, 0.9213) .. (10.0000, 0.7538) .. controls (10.0000, 0.5779) and
		(9.9183, 0.4083) .. (9.7550, 0.2450) .. controls (9.5917, 0.0817) and (9.4221,
		-0.0000) .. (9.2462, -0.0000) .. controls (9.0787, -0.0000) and (8.9364,
		0.0586) .. (8.8191, 0.1759) -- (4.6042,4.3908) .. controls (3.8672, 3.8422)
		and (3.1030, 3.5679) .. (2.3115, 3.5679) .. controls (1.6290, 3.5679) and
		(1.0731, 3.7825) .. (0.6438, 4.2118) .. controls (0.2146, 4.6410) and (0.0000,
		5.1969) .. (0.0000, 5.8794) .. controls (0.0000, 6.5494) and (0.1989, 7.2048)
		.. (0.5967, 7.8455) .. controls (0.9945, 8.4862) and (1.5138, 9.0055) ..
		(2.1545, 9.4033) .. controls (2.7952, 9.8011) and (3.4505, 10.0000) ..
		(4.1206, 10.0000) .. controls (4.8031, 10.0000) and (5.3590, 9.7854) ..
		(5.7883, 9.3562) .. controls (6.2175, 8.9269) and (6.4321, 8.3710) .. (6.4321,
		7.6885) .. controls (6.4321, 6.8970) and (6.1578, 6.1328) .. (5.6092, 5.3958)
		-- (7.8391,3.1659) -- (8.4421,3.7689) .. controls (8.4296, 3.7815) and
		(8.3751, 3.8328) .. (8.2788, 3.9228) .. controls (8.1825, 4.0128) and (8.0987,
		4.0935) .. (8.0276, 4.1646) .. controls (7.9564, 4.2358) and (7.8873, 4.3122)
		.. (7.8203, 4.3939) .. controls (7.7533, 4.4756) and (7.7198, 4.5352) ..
		(7.7198, 4.5729) .. controls (7.7198, 4.6441) and (7.8224, 4.7823) .. (8.0276,
		4.9875) .. controls (8.2328, 5.1927) and (8.3710, 5.2953) .. (8.4421, 5.2953)
		.. controls (8.4966, 5.2953) and (8.5447, 5.2743) .. (8.5866, 5.2325) ..
		controls (8.6117, 5.2073) and (8.7080, 5.1142) .. (8.8755, 4.9529) .. controls
		(9.0430, 4.7917) and (9.2147, 4.6253) .. (9.3906, 4.4536) .. controls (9.5665,
		4.2819) and (9.7476, 4.1018) .. (9.9339, 3.9134) .. controls (10.1203, 3.7250)
		and (10.2731, 3.5616) .. (10.3925, 3.4234) .. controls (10.5118, 3.2852) and
		(10.5715, 3.1994) .. (10.5715, 3.1659) -- cycle;
	\end{tikzpicture}%
}

% \faCorridor - modified \faDungeon icon from fontawesome5
\newcommand{\faCorridor}{%
	\begin{tikzpicture}[baseline={([yshift=-0.375\docFontSize]current bounding box.center)}, y=\docFontSize, x=\docFontSize, yscale=0.025, xscale=0.025, inner sep=0pt, outer sep=0pt]
		\path[fill,line width=0.283pt] (26.2389,27.7122) .. controls (26.3402, 27.6265)
		and (26.4494, 27.5407) .. (26.5429, 27.4550) .. controls (27.2679, 26.8157)
		and (28.3358, 26.6365) .. (29.1465, 27.1743) -- (34.4161,30.6900) .. controls
		(35.3048, 31.2824) and (35.5231, 32.4985) .. (34.8137, 33.2936) .. controls
		(33.5197, 34.7202) and (32.0308, 35.9674) .. (30.3782, 36.9808) .. controls
		(29.4506, 37.5498) and (28.2813, 37.0899) .. (27.8759, 36.0765) --
		(25.4983,30.1365) .. controls (25.1476, 29.2713) and (25.5139, 28.2969) ..
		(26.2389, 27.7044) -- cycle(25.5685,37.0431) .. controls (25.9661, 38.0409)
		and (25.4438, 39.1791) .. (24.3992, 39.4207) .. controls (22.9727, 39.7403)
		and (21.4838, 39.9118) .. (19.9559, 39.9118) .. controls (18.4280, 39.9118)
		and (16.9391, 39.7403) .. (15.5126, 39.4129) .. controls (14.4602, 39.1791)
		and (13.9380, 38.0409) .. (14.3433, 37.0431) -- (16.7053,31.1343) .. controls
		(17.0561, 30.2535) and (18.0149, 29.7935) .. (18.9659, 29.8871) .. controls
		(19.2933, 29.9183) and (19.6207, 29.9339) .. (19.9559, 29.9339) .. controls
		(20.2911, 29.9339) and (20.6263, 29.9183) .. (20.9459, 29.8871) .. controls
		(21.8891, 29.7935) and (22.8480, 30.2535) .. (23.2065, 31.1343) --
		cycle(5.1059,33.2858) .. controls (4.3965, 32.4907) and (4.6148, 31.2746) ..
		(5.5035, 30.6822) -- (10.7731,27.1665) .. controls (11.5760, 26.6287) and
		(12.6517, 26.8080) .. (13.3767, 27.4472) .. controls (13.4780, 27.5329) and
		(13.5794, 27.6265) .. (13.6885, 27.7044) .. controls (14.4135, 28.2891) and
		(14.7720, 29.2713) .. (14.4291, 30.1365) -- (12.0359,36.0765) .. controls
		(11.6306, 37.0821) and (10.4535, 37.5420) .. (9.5336, 36.9808) .. controls
		(7.8810, 35.9674) and (6.3921, 34.7202) .. (5.1059, 33.2858) --
		cycle(29.5831,22.5985) .. controls (29.6532, 22.3413) and (29.7156, 22.0840)
		.. (29.7624, 21.8190) .. controls (29.9572, 20.8056) and (30.7757, 19.9559) ..
		(31.8047, 19.9559) -- (38.0409,19.9559) .. controls (39.0777, 19.9559) and
		(39.9196, 20.7978) .. (39.8261, 21.8268) .. controls (39.6312, 23.9471) and
		(39.1011, 25.9739) .. (38.2904, 27.8525) .. controls (37.8617, 28.8581) and
		(36.6222, 29.1465) .. (35.7102, 28.5463) -- (30.3626,24.9839) .. controls
		(29.5987, 24.4772) and (29.3336, 23.4872) .. (29.5831, 22.6063) --
		cycle(4.2017,28.5463) .. controls (3.2974, 29.1543) and (2.0502, 28.8581) ..
		(1.6214, 27.8525) .. controls (0.8107, 25.9739) and (0.2806, 23.9471) ..
		(0.0857, 21.8268) .. controls (-0.0078, 20.7978) and (0.8341, 19.9559) ..
		(1.8709, 19.9559) -- (8.1071,19.9559) .. controls (9.1439, 19.9559) and
		(9.9624, 20.7978) .. (10.1494, 21.8190) .. controls (10.1962, 22.0840) and
		(10.2586, 22.3413) .. (10.3287, 22.5985) .. controls (10.5704, 23.4872) and
		(10.3131, 24.4694) .. (9.5492, 24.9761) -- cycle(8.1071,17.4614) --
		(1.8709,17.4614) .. controls (0.8341, 17.4614) and (0.0000, 16.6273) ..
		(0.0000, 15.5906) -- (0.0000,11.8488) .. controls (0.0000, 10.8120) and
		(0.8341, 9.9780) .. (1.8709, 9.9780) -- (8.1071,9.9780) .. controls (9.1439,
		9.9780) and (9.9780, 10.8120) .. (9.9780, 11.8488) -- (9.9780,15.5906) ..
		controls (9.9780, 16.6273) and (9.1439, 17.4614) .. (8.1071, 17.4614) --
		cycle(31.8047,17.4614) .. controls (30.7680, 17.4614) and (29.9339, 16.6273)
		.. (29.9339, 15.5906) -- (29.9339,11.8488) .. controls (29.9339, 10.8120) and
		(30.7680, 9.9780) .. (31.8047, 9.9780) -- (38.0409,9.9780) .. controls
		(39.0777, 9.9780) and (39.9118, 10.8120) .. (39.9118, 11.8488) --
		(39.9118,15.5906) .. controls (39.9118, 16.6273) and (39.0777, 17.4614) ..
		(38.0409, 17.4614) -- cycle(1.8709,7.4835) .. controls (0.8341, 7.4835) and
		(0.0000, 6.6494) .. (0.0000, 5.6126) -- (0.0000,1.8709) .. controls (0.0000,
		0.8341) and (0.8341, 0.0000) .. (1.8709, 0.0000) -- (8.1071,0.0000) ..
		controls (9.1439, 0.0000) and (9.9780, 0.8341) .. (9.9780, 1.8709) --
		(9.9780,5.6126) .. controls (9.9780, 6.6494) and (9.1439, 7.4835) .. (8.1071,
		7.4835) -- cycle(31.8047,7.4835) .. controls (30.7680, 7.4835) and (29.9339,
		6.6494) .. (29.9339, 5.6126) -- (29.9339,1.8709) .. controls (29.9339, 0.8341)
		and (30.7680, 0.0000) .. (31.8047, 0.0000) -- (38.0409,0.0000) .. controls
		(39.0777, 0.0000) and (39.9118, 0.8341) .. (39.9118, 1.8709) --
		(39.9118,5.6126) .. controls (39.9118, 6.6494) and (39.0777, 7.4835) ..
		(38.0409, 7.4835) -- cycle;
	\end{tikzpicture}%
}

\RequirePackage{fontawesome5}% icons

% icon vertical kerning
\newlength{\iconLower}
\setlength{\iconLower}{0.1\docFontSize}

% \icon{\icon}
% print an icon at the start of the line without indentation
\newcommand{\icon}[1]{\noindent\lower\iconLower\hbox{#1}}

% \rot[angle]{contents}
% \iconrot[angle]{icon}
% rotated icon
\newcommand{\rot}[2][45]{\rotatebox[origin=c]{#1}{#2}}
\newcommand{\iconrot}[2][45]{\rotatebox[origin=c]{#1}{\icon{#2}}}

% \icontitle{\icon}{\title}{Text}
% print an icon at the start of the \title (\section, \paragraph, etc.)
\newcommand{\icontitle}[3]{#2[#3]{\icon{#1}~#3}}

% SHORTCUTS

% Arrows
\def\iconArrows{\faArrows*}
\def\iconArrowsX{\faExpandArrows*}
\def\iconArrowsV{\faArrowsAltV}
\def\iconArrowsH{\faArrowsAltH}
\def\iconArrowsS{\rot\faArrowsAltH}
\def\iconArrowsB{\rot\faArrowsAltV}

% Arrow
\def\iconArrowNW{\rot\faArrowUp}
\def\iconArrowN{\faArrowUp}
\def\iconArrowNE{\rot\faArrowRight}
\def\iconArrowE{\faArrowRight}
\def\iconArrowSE{\rot\faArrowDown}
\def\iconArrowS{\faArrowDown}
\def\iconArrowSW{\rot\faArrowLeft}
\def\iconArrowW{\faArrowLeft}

% ArrowCircle
\def\iconArrowCircleNW{\rot\faArrowCircleUp}
\def\iconArrowCircleN{\faArrowCircleUp}
\def\iconArrowCircleNE{\rot\faArrowCircleRight}
\def\iconArrowCircleE{\faArrowCircleRight}
\def\iconArrowCircleSE{\rot\faArrowCircleDown}
\def\iconArrowCircleS{\faArrowCircleDown}
\def\iconArrowCircleSW{\rot\faArrowCircleLeft}
\def\iconArrowCircleW{\faArrowCircleLeft}

% ArrowAltCircle
\def\iconArrowAltCircleNW{\rot{\faIcon[regular]{arrow-alt-circle-up}}}
\def\iconArrowAltCircleN{\faIcon[regular]{arrow-alt-circle-up}}
\def\iconArrowAltCircleNE{\rot{\faIcon[regular]{arrow-alt-circle-right}}}
\def\iconArrowAltCircleE{\faIcon[regular]{arrow-alt-circle-right}}
\def\iconArrowAltCircleSE{\rot{\faIcon[regular]{arrow-alt-circle-down}}}
\def\iconArrowAltCircleS{\faIcon[regular]{arrow-alt-circle-down}}
\def\iconArrowAltCircleSW{\rot{\faIcon[regular]{arrow-alt-circle-left}}}
\def\iconArrowAltCircleW{\faIcon[regular]{arrow-alt-circle-left}}

% Chevron
\def\iconChevronNW{\rot\faChevronUp}
\def\iconChevronN{\faChevronUp}
\def\iconChevronNE{\rot\faChevronRight}
\def\iconChevronE{\faChevronRight}
\def\iconChevronSE{\rot\faChevronDown}
\def\iconChevronS{\faChevronDown}
\def\iconChevronSW{\rot\faChevronLeft}
\def\iconChevronW{\faChevronLeft}

% ChevronCircle
\def\iconChevronCircleNW{\rot\faChevronCircleUp}
\def\iconChevronCircleN{\faChevronCircleUp}
\def\iconChevronCircleNE{\rot\faChevronCircleRight}
\def\iconChevronCircleE{\faChevronCircleRight}
\def\iconChevronCircleSE{\rot\faChevronCircleDown}
\def\iconChevronCircleS{\faChevronCircleDown}
\def\iconChevronCircleSW{\rot\faChevronCircleLeft}
\def\iconChevronCircleW{\faChevronCircleLeft}

% Level
\def\iconLevelUp{\faLevelUp*}
\def\iconLevelDown{\faLevelDown*}

% Misc
\def\iconBookmark{\faBookmark}
\def\iconContainer{\faCube}
\def\iconCorridor{\faCorridor}
\def\iconCharacter{\faUser}
\def\iconDay{\faSun}
\def\iconGroup{\faUsers}
\def\iconSize{\faRulerCombined}
\def\iconDanger{\faSkullCrossbones}
\def\iconDirections{\faMapSigns}
\def\iconDoor{\faDungeon}
\def\iconEncounter{\faExclamationTriangle}
\def\iconHidden{\faSearch}
\def\iconKey{\faOldKey}
\def\iconLock{\faLock}
\def\iconMagic{\faMagic}
\def\iconMonster{\faDragon}
\def\iconMoon{\faMoon}
\def\iconNight{\faMoon}
\def\iconReward{\faTrophy}
\def\iconStar{\faStar}
\def\iconSun{\faSun}
\def\iconTimer{\faHourglassHalf}
\def\iconTravel{\faHiking}
\def\iconTreasure{\faGem}
\def\iconTrigger{\faBolt}
\def\iconVisible{\faEye}

%%%%%%%%%%
% IMAGES %
%%%%%%%%%%

\makeatletter
\providecommand*{\input@path}{}
\newcommand{\IfImageExists}[3]{%
	\begingroup
	\ifdefined\Ginput@path
		\edef\input@path{\input@path\Ginput@path}%
	\fi
	\IfFileExists{#1}{\endgroup#2}{\endgroup#3}%
}
\makeatother


% \placeholder[width]{filename}{height}
%
% #1 - width (optional) default: \linewidth
% #2 - filename
% #3 - height
\newcommand{\placeholder}[3][\linewidth]{%
	\par\noindent\begin{minipage}[c][#3][c]{#1}
		\centering
		\begin{tikzpicture}
			\draw (0,0) rectangle (#1,#3);
			\node at (#1/2,#3/2) {\faImage~\detokenize\expandafter{#2}};
			\node at (#1/2,#3/2-\baselineskip) {\faRulerVertical~\detokenize\expandafter{#3}};
		\end{tikzpicture}
	\end{minipage}\par%
}

% \dimage[options]{filename}[extension]{height}
%
% #1 - options (optional)
% #2 - filename
% #3 - extension (optional) default: png
% #4 - height (for placeholder size)
\NewDocumentCommand{\dimage}{ O{} m O{png} m }{%
	\IfImageExists{#2.#3}{%
		\noindent\includegraphics[width=\linewidth,#1]{#2.#3}%
	}{\placeholder{#2}{#4}}% else
}

% ! LEGACY !
% use \dimage[options]{filename}[extension]{height} instead
% \dimageopt{filename}[extension]{height}{options}
\NewDocumentCommand{\dimageopt}{ m O{png} m m }{%
	\IfImageExists{#1.#2}{%
		\noindent\includegraphics[width=\linewidth,#4]{#1.#2}%
	}{\placeholder{#1}{#3}}% else
}

% full-page image at the bottom of the page
% place BEFORE anything on the page
% \dimagebottom[options]{filename}[extension]{height}
\RequirePackage{stfloats}
\NewDocumentCommand{\dimagebottom}{ O{} m O{png} m }{{% <- second pair of brackets is intentional
		\noindent\begin{figure*}[bp]
			\centering\IfImageExists{#2.#3}{%
				\includegraphics[width=\textwidth,#1]{#2.#3}%
			}{\placeholder{#2}{#4}}% else
		\end{figure*}
		\vspace{-29.5pt}% fix spacing at the top of the page
		\\
}}

% full-page image on a separate page (\thispagestyle{empty}).
% \dimagepage[options]{filename}[extension]
\NewDocumentCommand{\dimagepage}{ O{} m O{png} }{{% <- second pair of brackets is intentional
		\newpage
		\thispagestyle{empty}%
		\topskip0pt
		\noindent\begin{picture}(0,617)
			\IfImageExists{#2.#3}{%
				\put(0,0){%
					\hbox{\includegraphics[width=\textwidth,#1]{#2.#3}}%
				}
			}
			{% else
				\put(0,315){%
					%	\fbox{\rule{0.985\textwidth}{0pt}\rule[-0.5ex]{0pt}{626pt}}%
					\placeholder[\textwidth]{#2}{636pt}%
				}
			}
		\end{picture}%
}}

%%%%%%%%%
% INDEX %
%%%%%%%%%

\RequirePackage{imakeidx}
\IfFileExists{itdr.ist}{% itdr.ist
	\makeindex[options=-s itdr]
}{% itdr/itdr.ist
	\makeindex[options=-s itdr/itdr]
}
\RequirePackage[totoc,columns=3,columnsep=1em,font=small,indentunit=1em,rule=0pt]{idxlayout}

% \newindex{name}{title}
\newcommand{\newindex}[2]{%
	\IfFileExists{itdr.ist}{% itdr.ist
		\makeindex[name=#1, title={#2}, options=-s itdr]
	}{% itdr/itdr.ist
		\makeindex[name=#1, title={#2}, options=-s itdr/itdr]
	}
}

%%%%%%%%%
% LISTS %
%%%%%%%%%

\RequirePackage{enumitem}

\setlist{noitemsep,topsep=0pt,parsep=0pt,partopsep=0pt}

\makeatletter

% itemize
\renewcommand{\labelitemi}{\starredbullet}
\renewcommand{\labelitemii}{\adfbullet{48}}
\renewcommand{\labelitemiii}{\adfbullet{43}}
\renewcommand{\labelitemiv}{\adfbullet{44}}

% enumerate
\def\enum@i{\arabic{enumi}}
\def\enum@ii{\arabic{enumii}}
\def\enum@iii{\Roman{enumiii}}
\def\enum@iv{\roman{enumiv}}

\renewcommand{\labelenumi}{\enum@i.}
\renewcommand{\labelenumii}{(\enum@ii)}
\renewcommand{\labelenumiii}{\enum@iii.}
\renewcommand{\labelenumiv}{(\enum@iv)}

% \itemrange{range}
%
% For example:
% 	\itemrange{3} second item
% for a second item in the list will produce:
% 	2â€“4. second item
\def\itemrange#1{%
	\ifnum \@enumdepth = 1
	\addtocounter{enumi}{1}%
	\let\original\labelenumi%
	\edef\labelenumi{\enum@i--\noexpand\enum@i.}%
	\addtocounter{enumi}{#1-2}%
	\item
	\def\labelenumi{\original}
	\else\ifnum \@enumdepth = 2
	\addtocounter{enumii}{1}%
	\let\original\labelenumii%
	\edef\labelenumii{(\enum@ii--\noexpand\enum@ii)}%
	\addtocounter{enumii}{#1-2}%
	\item
	\def\labelenumii{\original}
	\else\ifnum \@enumdepth = 3
	\addtocounter{enumiii}{1}%
	\let\original\labelenumiii%
	\edef\labelenumiii{\enum@iii--\noexpand\enum@iii.}%
	\addtocounter{enumiii}{#1-2}%
	\item
	\def\labelenumiii{\original}
	\else\ifnum \@enumdepth = 4
	\addtocounter{enumiv}{1}%
	\let\original\labelenumiv%
	\edef\labelenumiv{(\enum@iv--\noexpand\enum@iv)}%
	\addtocounter{enumiv}{#1-2}%
	\item
	\def\labelenumiv{\original}
	\fi\fi\fi\fi
}
\makeatother% LISTS

%%%%%%%%%%%%%%
% SECTIONING %
%%%%%%%%%%%%%%

% Titles
\RequirePackage[newlinetospace]{titlesec}
\RequirePackage{titletoc}
\RequirePackage[titles]{tocloft}% titles option - do not typeset ToC, LoF, LoT titles
\newlength{\tocstep}
\setlength{\tocstep}{12pt}% toc "tabbing" step distance
\setlength{\parskip}{0.4ex}% distance between paragraphs

% hide section and subsection numbers in table of contents, along with corresponding indentation
\renewcommand{\thechapter}{\arabic{chapter}.}
\renewcommand\thesection{}
\renewcommand\thesubsection{}
\makeatletter
\def\@seccntformat#1{\csname #1ignore\expandafter\endcsname\csname the#1\endcsname\quad}
\let\sectionignore\@gobbletwo
\let\latex@numberline\numberline
\def\numberline#1{\if\relax#1\relax\else\latex@numberline{#1}\fi}
\makeatother

% chapter
\titleformat{\chapter}
	{\normalfont\scshape\LARGE}{\thechapter\ }{0em}{}
\titlespacing*{\chapter}{0em}{0ex}{1ex}
\def\chapterautorefname{Chapter}
\titlecontents{chapter}
	[0em]% left
	{\vspace{1pc}\bfseries}% above-code
	{\makebox[\tocstep][l]{\thecontentslabel}}% numbered-entry-format
	{\makebox[0\tocstep][l]{}}% numberless-entry-format
	{\cftchapleader\quad\contentspage}% filler-page-format
	[]% below-code

% unnumbered chapter
\makeatletter
\newcommand{\chapterx}{\@ifstar{\chapterx@star}{\chapterx@toc}}

\newcommand{\chapterx@toc}[1]{%
	\chapter*{#1}
	\markboth{#1}{}%
	\addcontentsline{toc}{chapter}{#1}%
}

\newcommand{\chapterx@star}[1]{%
	\chapter*{#1}
	\markboth{#1}{}%
}
\makeatother

% section
\titleformat{\section}
	{\normalfont\scshape\Large}{\thesection}{0em}{}
	[{\titleline{\color{black}\titlerule[1pt]}}]
\titlespacing*{\section}{0em}{\parskip}{1ex}
\titlecontents{section}
	[\tocstep]% left
	{}% above-code
	{\thecontentslabel}% numbered-entry-format
	{}% numberless-entry-format
	{\cftsecleader\quad\contentspage}% filler-page-format
	[]% below-code

% subsection
\titleformat{\subsection}
	{\normalfont\bfseries\scshape\large}{\thesubsection}{0em}{}
\titlespacing*{\subsection}{0em}{\parskip}{0ex}
\titlecontents{subsection}
	[2\tocstep]% left
	{}% above-code
	{\thecontentslabel}% numbered-entry-format
	{}% numberless-entry-format
	{\cftsubsecleader\quad\contentspage}% filler-page-format
	[]% below-code

% subsubsection
\titleformat{\subsubsection}
	{\normalfont\bfseries\scshape\normalsize}{\thesubsubsection}{0em}{}[]
\titlespacing*{\subsubsection}{0em}{\parskip}{0ex}
\titlecontents{subsubsection}
	[3\tocstep]% left
	{}% above-code
	{\thecontentslabel}% numbered-entry-format
	{}% numberless-entry-format
	{\cftsubsubsecleader\quad\contentspage}% filler-page-format
	[]% below-code

% paragraphsection
\titleclass{\paragraphsection}{straight}[\subsubsection]
\newcounter{paragraphsection}
\renewcommand{\theparagraphsection}{\arabic{paragraphsection}}
\titleformat{\paragraphsection}
	{\normalfont\bfseries\normalsize\scshape}{\theparagraphsection}{0em}{}[]
\titlespacing*{\paragraphsection}{0em}{\parskip}{0ex}
\newcommand{\cftparsecleader}{\cftdotfill{\cftsubsecdotsep}}
\titlecontents{paragraphsection}
	[3\tocstep]% left
	{}% above-code
	{\thecontentslabel}% numbered-entry-format
	{}% numberless-entry-format
	{\cftparsecleader\quad\contentspage}% filler-page-format
	[]% below-code

% paragraph
\titleformat{\paragraph}
	{\normalfont\bfseries\normalsize}{\theparagraph}{0em}{}[]
\titlespacing*{\paragraph}{0em}{\parskip}{0ex}
\titlecontents{paragraph}
	[4\tocstep]% left
	{}% above-code
	{\thecontentslabel}% numbered-entry-format
	{}% numberless-entry-format
	{\cftparaleader\quad\contentspage}% filler-page-format
	[]% below-code

% paragraphsubsection
\titleclass{\paragraphsubsection}{straight}[\paragraph]
\newcounter{paragraphsubsection}
\renewcommand{\theparagraphsubsection}{\Alph{paragraphsubsection}}
\titleformat{\paragraphsubsection}[runin]
	{\normalfont\bfseries\small\scshape}{\theparagraphsubsection}{0em}{}[]
\titlespacing*{\paragraphsubsection}{\parindent}{\parskip}{\wordsep}
\newcommand{\cftsubparsecleader}{\cftdotfill{\cftsubsecdotsep}}
\titlecontents{paragraphsubsection}
	[5\tocstep]% left
	{}% above-code
	{\thecontentslabel}% numbered-entry-format
	{}% numberless-entry-format
	{\cftsubparsecleader\quad\contentspage}% filler-page-format
	[]% below-code

% subparagraph
\titleformat{\subparagraph}[runin]
	{\normalfont\bfseries\normalsize}{\thesubparagraph}{0em}{}[]
\titlespacing*{\subparagraph}{\parindent}{\parskip}{\wordsep}
\titlecontents{subparagraph}
	[5\tocstep]% left
	{}% above-code
	{\thecontentslabel}% numbered-entry-format
	{}% numberless-entry-format
	{\cftsubparaleader\quad\contentspage}% filler-page-format
	[]% below-code

%%%%%%%%%%
% TABLES %
%%%%%%%%%%

% Table header
\newcommand{\header}[1]{\vspace*{-1ex}\noindent\paragraph{#1}\vspace*{-1ex}}

% Left-aligned column
\newcolumntype{L}{X}
% Centered column
\newcolumntype{C}{>{\centering\arraybackslash}X}
% Right-aligned column
\newcolumntype{R}{>{\raggedleft\arraybackslash}X}

% Table environment
\RequirePackage{tabularx}
\newenvironment{dtable}[1][LL]{%
	\vspace{0.1ex}\noindent
	\rowcolors{1}{dColor1}{dColor2}% Alternate colors
	\linespread{0.5}\selectfont{}% halved linespread
	\setlength{\extrarowheight}{5pt}% extra vertical space at the top and bottom of each row
	\tabularx{\linewidth}{#1}%
}{\endtabularx\vspace{0.5ex}\noindent}

% \pcell[width]{contents}[linespread]
% A wrapper of \pbox to use inside tabular cells, with custom linespread.
%
% width - (optional) maximum paragraph width (\linewidth by default)
% contents - paragraph contents
% linespread - (optional) custom linespread factor (0.5 by default)
\RequirePackage{pbox}
\makeatletter
\NewDocumentCommand{\pcell}{ O{\linewidth} m O{0.5} }{%
	\pbox[t]{#1}{\linespread{#3}\selectfont{}#2\strut}%
}
\makeatother

%%%%%%%%%%%%%
% TEMPLATES %
%%%%%%%%%%%%%

% Clear to left page
\makeatletter
\newcommand*{\cleartoleftpage}{%
	\clearpage
	\if@twoside
	\ifodd\c@page
	\hbox{}\thispagestyle{empty}\newpage
	\if@twocolumn
	\hbox{}\thispagestyle{empty}\newpage
	\fi
	\fi
	\fi
}
\makeatother

% \tsub{text}
% a shorthand for \textsubscript
\newcommand{\tsub}[1]{\textsubscript{#1}}

% \tsup{text}
% a shorthand for \textsuperscript
\newcommand{\tsup}[1]{\textsuperscript{#1}}

% \dbar
% a prettier double bar glyph
%\newcommand{\dbar}{\textbar\kern-1ex\textbar}
\newcommand{\dbar}{\normalfont\textbar\textbar}

% \skipline[\baselineskip]
\newcommand{\skipline}[1][\baselineskip]{\vspace*{#1}}

% \tight
\newcommand{\tight}{\looseness=-1}

% SAVES %

% \save{ABILITY}
\newcommand{\save}[1]{#1~Save}

% \saves{ABILITY}
\newcommand{\saves}[1]{#1~Saves}

%
% !NOTE!
%
% Starred templates (template@star) do not push names to the index, while the default ones (template@index) do.
% In both cases, they add to the TOC at paragraph level.
%

% FEAT %

\makeatletter
\newcommand{\feat}{\@ifstar{\feat@star}{\feat@index}}

% \feat[index]{name}
\newcommand{\feat@index}[2][\jobname]{%
	\paragraphsection[#2]{\decosix~#2~\decosix}
	\index[#1]{#2 (Feature)}%
}

% \feat*{name}
\newcommand{\feat@star}[1]{%
	\paragraphsection[#1]{\decosix~#1~\decosix}
}

% ANCESTRY %

\newcommand{\feata}{\@ifstar{\feata@star}{\feata@index}}

% \feata[index]{name}
\newcommand{\feata@index}[2][\jobname]{%
	\paragraphsection[#2]{\decosix~#2~\decosix}
	\index[#1]{#2 (Feature, ancestry)}%
}

% \feata*{name}
\newcommand{\feata@star}[1]{%
	\paragraphsection[#1]{\decosix~#1~\decosix}
}

% BACKGROUND %

\newcommand{\featb}{\@ifstar{\featb@star}{\featb@index}}

% \featb[index]{name}
\newcommand{\featb@index}[2][\jobname]{%
	\paragraphsection[#2]{\decosix~#2~\decosix}
	\index[#1]{#2 (Background)}%
}

% \featb*{name}
\newcommand{\featb@star}[1]{%
	\paragraphsection[#1]{\decosix~#1~\decosix}
}
\makeatother% FEATS

% OTHER %

% \featmt
\newcommand{\featmt}{%
	{\slshape Can be taken multiple times.}\\
}
% \feathp
\newcommand{\feathp}{%
	{\slshape Roll twice for HP and take the better result.}\\
}
% \feate
\newcommand{\feate}[1]{%
	{\bfseries Eligibility:}~{\slshape #1}\\
}
% \featadv
\newcommand{\featadv}{% the next line is intentionally empty
	
	{\bfseries Advancement:}
}

% EQUIP %

\makeatletter
\newcommand{\equip}{\@ifstar{\equip@star}{\equip@index}}

% \equip[index]{name}{price}
\newcommand{\equip@index}[3][\jobname]{%
	\index[#1]{#2}
	\subparagraph{#2} (#3):%
}

% \equip*{name}{price}
\newcommand{\equip@star}[2]{%
	\subparagraph{#1} (#2):%
}

% WEAPON %

\newcommand{\weapon}{\@ifstar{\weapon@star}{\weapon@index}}

% \weapon[index]{name}{price}{damage}
\newcommand{\weapon@index}[4][\jobname]{%
	\index[#1]{#2}
	\subparagraph{#2} (#3): #4 Damage.%
}

% \weapon*{name}{price}{damage}
\newcommand{\weapon@star}[3]{%
	\subparagraph{#1} (#2): #3 Damage.%
}

% ARMOUR %

\newcommand{\armour}{\@ifstar{\armour@star}{\armour@index}}

% \armour[index]{name}{price}{value}
\newcommand{\armour@index}[4][\jobname]{%
	\index[#1]{#2}
	\subparagraph{#2} (#3): Armour #4.%
}

% \armour*{name}{price}{value}
\newcommand{\armour@star}[3]{%
	\subparagraph{#1} (#2): Armour #3.%
}
\makeatother% EQUIP

% DOMAINS %

% \sizpop[pop]{siz}
% Print domain size along with appropriate populace
\def\populace#1{\ (Populace #1)}
\newcommand{\sizpop}[2][]{%
	SIZ~#2%
	\ifx\relax#1\relax% if pop is empty
		\ifcase#2 \populace{<100}% 0
		\or \populace{100}% 1
		\or \populace{300}% 2
		\or \populace{600}% 3
		\or \populace{1,000}% 4
		\or \populace{3,000}% 5
		\or \populace{5,000}% 6
		\or \populace{7,500}% 7
		\or \populace{10,000}% 8
		\or \populace{15,000}% 9
		\or \populace{20,000}% 10
		\or \populace{30,000}% 11
		\or \populace{50,000}% 12
		\or \populace{75,000}% 13
		\or \populace{100,000}% 14
		\or \populace{150,000}% 15
		\or \populace{200,000}% 16
		\or \populace{300,000}% 17
		\or \populace{500,000}% 18
		\or \populace{750,000}% 19
		\or \populace{1,000,000}% 20
		\else \populace{unknown}%
		\fi%ifcase
	\else% if pop is not empty
		\populace{#1}%
	\fi
}

% \domain{ruler}{siz}[populace]{details}
\NewDocumentCommand{\domain}{m m O{} m}{%
	\begin{lbar}
		Ruler: #1.\\
		\sizpop[#3]{#2}.\ifx\relax#4\relax\else
		\\#4\fi
	\end{lbar}%
}

% ROOMS %

\RequirePackage{lettrine}

\makeatletter
\newcommand*{\@skip@empty@lines}[1]{%
	\@nobreakfalse
	\global\@noskipsectrue
	\everypar{%
		\if@noskipsec
		\global\@noskipsecfalse
		{\setbox\z@\lastbox}% remove paragraph indentation
		#1%
		\else
		\everypar{}%
		\fi}%
	\ignorespaces
}

\def\@ignore@paragraphs{%
	\begingroup
	\catcode13=10
	\@ifnextchar\par
	{\endgroup\expandafter\@ignore@paragraphs\@gobble}%
	{\endgroup}%
}


% \room[\title]{idx}{name}
%
% title - (optional) title level (\subsection by default)
% idx - the map index of the room (two-line lettrine)
% name - the name of the room
%
\newcommand{\room}[3][\subsection]{%
	\@skip@empty@lines{%
		\lettrine[findent=0.5em,nindent=0em]{#2}{%
			\raisebox{-0.5ex}{\parbox{\linewidth-\widthof{\Huge #2}}{#1[#2. #3]{#3}}}\@ignore@paragraphs
		}\\\label{#2. #3}%%lettrine
	}
}
\makeatother

% \dimensions[unit]{x}{y}[z]
%
% unit - (optional) measure unit (~ft. by default)
% x, y - horizontal dimensions
% z - (optional) vertical dimension
%
\NewDocumentCommand{\dimensions}{ O{~ft.} m m O{} }{%
	#2$\times$#3%
	\ifx&#4&\else
	$\times$#4%
	\fi
	\ifx&#1&\else
	#1%
	\fi
}

% SPELLS %

% DEFAULT SPELL INDEX
%
% Define:
%	\newindex{\spells}{Spell List}
% before the start of your document.
\def\spells{spells}

\makeatletter
\newcommand{\spell}{\@ifstar{\spell@star}{\spell@index}}

% \spell[index]{name} description.
%
% Define:
%	\def \spellcircle {X}
% (where X is C, 1, 2, 3, 4, or 5) before calling the \spell command
\newcommand{\spell@index}[2][\spells]{%
	\textbf{#2:}\index[#1]{#2 (\spellcircle)}%
}

% \spell*{name} description.
\newcommand{\spell@star}[1]{%
	\textbf{#1:}%
}

% STANDALONE SPELL %
% (does not need the \spellcircle being defined)
\newcommand{\sspell}{\@ifstar{\sspell@star}{\sspell@index}}

% \sspell[index]{name}{circle}
\newcommand{\sspell@index}[3][\spells]{%
	\textbf{#2 (#3):}\index[#1]{#2 (#3)}%
}

% \sspell*{name}{circle}
\newcommand{\sspell@star}[2]{%
	\textbf{#1 (#2):}\index[spells]{#1 (#2)}%
}
\makeatother% SPELLS

% IPARAGRAPH %

% \iparagraph[index]{title}
% (indexed paragraph)
\newcommand{\iparagraph}[2][\jobname]{%
	\index[#1]{#2}
	\paragraph{#2}
}

% STATPAR %

\makeatletter
\newcommand{\statpar}{\@ifstar{\statpar@star}{\statpar@index}}

% \statpar[index]{monster name}
\newcommand{\statpar@index}[2][\jobname]{%
	\index[#1]{#2}
	\paragraphsection[#2]{#2}%
}

% \statpar*{monster name}
\newcommand{\statpar@star}[1]{%
	\paragraphsection[#1]{#1}%
}
\makeatother

% UNDERPAR %

\def\underparskip{-2\parskip}

% \underpar{text}
\newcommand{\underpar}[1]{%
	\vspace{\underparskip}%
	{\noindent\small\scshape #1}\\
}

% CLASS %

\makeatletter
\newcommand{\class}{\@ifstar{\class@star}{\class@index}}

% \class[index]{name}
\newcommand{\class@index}[2][\jobname]{%
	\paragraphsection[#2]{\decosix~#2~\decosix}
	\index[#1]{#2 (Class)}%
}

% \class*{name}
\newcommand{\class@star}[1]{%
	\paragraphsection[#1]{\decosix~#1~\decosix}
}
\makeatother

% CREED %

\makeatletter
\newcommand{\creed}{\@ifstar{\creed@star}{\creed@index}}

% \creed[index]{name}
\newcommand{\creed@index}[2][\jobname]{%
	\paragraphsection[#2]{\decosix~#2~\decosix}
	\index[#1]{#2 (Creed)}%
}

% \creed*{name}
\newcommand{\creed@star}[1]{%
	\paragraphsection[#1]{\decosix~#1~\decosix}
}
\makeatother

% MISC

% \travelunit
\newcommand{\travelunit}[1]{%
	\FPeval{\result}{trunc(#1 * 5 : 0)}\result}

% fill the page with lines
\newcommand{\dnotes}[1][4ex]{%
	\thispagestyle{empty}%
	\begingroup\offinterlineskip
	\hrule height 0pt
	\vskip-\topskip
	\leaders\vbox to #1{\vfill\hbox to\hsize{\hrulefill}}\vfill
	\endgroup
	\clearpage
}

%%%%%%%
% TOC %
%%%%%%%

\RequirePackage[toc]{multitoc}
\renewcommand{\contentsname}{CONTENTS}
\newcommand{\toc}[1][1]{%
	\begingroup
	\let\cleardoublepage\relax
	\let\clearpage\relax
	\hyphenchar\font=-1% disable hyphenation
	\setcounter{tocdepth}{#1}\tableofcontents
	\thispagestyle{toc}
	\hyphenchar\font=`\-% enable hyphenation
	\endgroup
	%\clearpage
}

%%%%%%%%
% WRAP %
%%%%%%%%

\RequirePackage{wrapfig2}

% \begin{wrap}[line number]{location}[overhang]{width}
\NewDocumentEnvironment{wrap}{o m o G{0pt}}%
{\wrapfloat{object}[#1]{#2}[#3]{#4}}%
{\endwrapfloat}

%%%%%%%%%%%%%%
% HYPERLINKS %
%%%%%%%%%%%%%%

% Hyperref should be loaded last
\RequirePackage{hyperref}
\RequirePackage{bookmark}% fixes title bookmark levels

% toclevel
\makeatletter
\def\toclevel@chapter{0}
\def\toclevel@section{1}
\def\toclevel@subsection{2}
\def\toclevel@subsubsection{3}
\def\toclevel@paragraphsection{4}
\def\toclevel@paragraph{5}
\def\toclevel@paragraphsubsection{6}
\def\toclevel@subparagraph{7}

\AtBeginDocument{%
	\hypersetup{%
		pdfborderstyle={/S/U/W 1},% underlined hyperlinks
		bookmarksdepth=5,% paragraph level depth bookmarks
		pdftitle={\title},
		pdfauthor={\author},
		pdfkeywords={\keywords},
	}
}
\makeatother

% \customref{label}{text}
\newcommand*{\customref}[2]{\hyperref[{#1}]{#2}}

% \roomref{label}
\newcommand{\roomref}[1]{\hyperref[{#1}]{\textbf{#1}}}

% \fullref{label}
\newcommand*{\fullref}[1]{\hyperref[{#1}]{\autoref*{#1}: \nameref*{#1}}}

% \safenameref{label}[fallback]
% if the label is undefined, fallback is printed instead
\makeatletter
\NewDocumentCommand{\safenameref}{ m O{} }{%
	\@ifundefined{r@#1}{#2}{\nameref{#1}}}
\makeatother

% \safepageref{before}{label}{after}[fallback]
% output: before ?? after
% where ?? is a page number of the label
% if label is undefined, fallback is printed instead
\makeatletter
\NewDocumentCommand{\safepageref}{ m m m O{} }{%
	\@ifundefined{r@#2}{#4}{#1\pageref{#2}#3}}
\makeatother

\pdfminorversion=4 % force PDF 1.4 for the Acrobat compatibility
